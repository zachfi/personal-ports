PORTNAME=	alloy
PORTVERSION=	1.0.0
PORTREVISION=	1
DISTVERSIONPREFIX=v
CATEGORIES=	sysutils

MAINTAINER=	contact@zach.fi
COMMENT=	Grafana Alloy for observability swiss-army

LICENSE=	MIT

BUILD_DEPENDS=	git:devel/git

USES=		go:1.22,modules
USE_GITHUB=	yes

GH_ACCOUNT=	grafana
GH_PROJECT=	alloy

# DISTFILES+=	syntax/go.rod

GO_PKGNAME=	github.com/${GH_ACCOUNT}/${GH_PROJECT}
GO_MODULE=	github.com/${GH_ACCOUNT}/${GH_PROJECT}
GO_TARGET=	github.com/${GH_ACCOUNT}/${GH_PROJECT}
GO_BUILDFLAGS=	-ldflags='-X github.com/grafana/alloy/internal/build.Version=v${PORTVERSION}'

USE_RC_SUBR=	alloy

 # Copy the go.mod so we can get all the dist files during fetch.
_USES_fetch+= 600:go-pre-fetch
go-pre-fetch:
	@${ECHO_MSG} "===> Fetching ${GO_MODNAME}/syntax dependency";
	(cd ${DISTDIR}/${DIST_SUBDIR}; [ -e syntax/go.mod ] || mkdir syntax/; \
		tar -xzf grafana-alloy-v1.0.0_GH0.tar.gz ${PORTNAME}-${PORTVERSION}/syntax/go.mod; \
		cp ${PORTNAME}-${PORTVERSION}/syntax/go.mod syntax/go.mod)

# Copy over the syntax/ directory from the source extract to ensure the go mod
# replace for ./syntax is handled with the correct files on disk.
_USES_extract+= 600:go-post-extract-syntax
go-post-extract-syntax:
	@cp -r ${WRKDIR}/${PORTNAME}-${PORTVERSION}/syntax ${GO_WRKSRC}/syntax;

do-install:
	${INSTALL_PROGRAM} ${WRKDIR}/bin/alloy ${STAGEDIR}${PREFIX}/bin/alloy

.include <bsd.port.mk>
