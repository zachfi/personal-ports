#!/bin/sh
#
# PRE-INSTALL:  Stop alloy if enabled so the binary can be replaced (avoids
#               ETXTBSY on FreeBSD when the Go binary is in use).
# POST-INSTALL: Restart alloy if enabled so the new binary is used.
# DEINSTALL:    Stop alloy if enabled before removal.
#

[ -z "${PACKAGE_BUILDING}" ] || exit 0

# PKG_PREFIX is set by pkg when running install/deinstall scripts.
: ${PKG_PREFIX:=/usr/local}
_rc_script="${PKG_PREFIX}/etc/rc.d/alloy"

# Load rc.conf to check alloy_enable (same as the rc.d script).
alloy_enable=NO
if [ -r /etc/rc.subr ]; then
	. /etc/rc.subr
	name=alloy
	rcvar=alloy_enable
	load_rc_config $name
fi
: ${alloy_enable:=NO}
[ "${alloy_enable}" = "YES" ] || exit 0

case "$2" in
PRE-INSTALL)
	# Stop before file replacement so the running binary can be overwritten.
	[ -x "${_rc_script}" ] && "${_rc_script}" stop 2>/dev/null || true
	;;
POST-INSTALL)
	# Run rc.d script directly so we don't depend on service(8) finding it.
	if [ -r "${_rc_script}" ]; then
		sh "${_rc_script}" start 2>/dev/null || true
	fi
	;;
DEINSTALL)
	[ -r "${_rc_script}" ] && sh "${_rc_script}" stop 2>/dev/null || true
	;;
esac
